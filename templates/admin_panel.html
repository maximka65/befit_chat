<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e9ecef;
            margin: 0;
            padding: 0;
            color: #343a40;
        }

        h3 {
            font-size: 18px;
            color: #495057;
            margin-top: 20px;
            border-bottom: 1px solid #ced4da;
            padding-bottom: 5px;
        }

        .user-list-item {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: #f8f9fa;
            position: relative; /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–æ–¥–∏—Ç–µ–ª—è */
            word-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç–µ –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≤—ã—Ö–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
        }

        .user-list-item.has-request {
            background-color: #fff3cd;
        }

        .user-list-item.has-request::before {
            content: "üìù";
            position: absolute;
            top: 10px;
            left: -25px;
            font-size: 18px;
            color: #ffc107;
        }

        .user-list-item.selected {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }

        .user-list-item .last-message-time {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .user-list-item .toggle-details {
            background-color: transparent;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 12px;
        }

        .user-list-item .user-agent, .user-list-item .page-url {
            display: none;
            font-size: 12px;
            color: #868e96;
            margin-top: 5px;
        }

        .highlight {
            background-color: #ffeeba;
        }

        .container {
            width: 90%;
            margin: 20px auto;
            display: flex;
            justify-content: space-between;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 18%;
            background-color: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 10px); /* –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —É—á–∏—Ç—ã–≤–∞—è –æ—Ç—Å—Ç—É–ø—ã */
            overflow-y: auto;
        }

        .content {
            width: 55%;
            background-color: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;

        }

        .requests-column {
            width: 20%;
            background-color: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 10px); /* –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —É—á–∏—Ç—ã–≤–∞—è –æ—Ç—Å—Ç—É–ø—ã */
            overflow-y: auto; /* –î–æ–±–∞–≤—å—Ç–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        }
        .panel h2 {
            margin-top: 0;
            font-size: 26px;
            color: #495057;
        }

        .panel-buttons {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 20px;
        }

        .panel-buttons button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }

        .panel-buttons button:hover {
            background-color: #0056b3;
        }

        .messages {
            flex-grow: 1;
            height: 80%;
            overflow-y: auto;
            max-height: calc(100vh - 150px); /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
            overflow-y: auto; /* –î–æ–±–∞–≤—å—Ç–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        }
        .active {
            display: block !important;
        }

        .message, .request {
            padding: 10px;
            cursor: pointer;
            position: relative;
        }

        .message:last-child, .request:last-child {
            border-bottom: none;
        }

        .message.user-message {
            text-align: left;
            max-width: 50%;
            background-color: #dcf8c6;
            border-radius: 20px;
            padding: 10px 15px;
            margin-bottom: 10px;
            margin-left: auto;
            margin-right: 10px;
            position: relative;
        }

        .message.bot-message {
            text-align: left;
            max-width: 50%;
            background-color: #cce5ff;
            border-radius: 20px;
            padding: 10px 15px;
            margin-bottom: 10px;
            margin-right: auto;
            position: relative;
        }

        .message .timestamp {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            display: block;
            margin-top: 10px;
            margin-right: 10px;
        }

        .highlight {
            background-color: #ffeeba;
            border-color: #ffdf7e;
        }

        .admin {
            font-weight: bold;
            color: #007bff;
        }

        .requests-column h2 {
            text-align: center;
            margin-top: 0;
            font-size: 22px;
            color: #495057;
            border-bottom: 1px solid #ced4da;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .request {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: none;
        }

        .request .contact-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .request .contact-info .name-container,
        .request .contact-info .phone-container {
            padding: 4px;
            border-radius: 3px;
            font-size: 12px;
            color: #fff;
            width: 48%;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .request .contact-info .name-container {
            background-color: #5a9bd5;
        }

        .request .contact-info .phone-container {
            background-color: #82c68e;
        }

        .request .message-content {
            font-size: 14px;
            color: #343a40;
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 2px solid #007bff;
        }

        .request .timestamp {
            font-size: 11px;
            color: #6c757d;
            text-align: right;
        }

        .message-input-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
            width: 100%; /* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —à–∏—Ä–∏–Ω—É –≤ 100% */
            background-color: #f8f9fa;
            border-top: 1px solid #ced4da;
            border-radius: 0 0 8px 8px;
        }

        .message-input-container textarea {
            flex-grow: 1;
            margin-right: 10px;
            padding: 12px 15px;
            height: 100px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ */
            border-radius: 8px; /* –ù–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–∏–π —Ä–∞–¥–∏—É—Å —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è */
            border: 1px solid #ced4da;
            font-size: 16px; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
            font-family: 'Roboto', sans-serif;
            box-sizing: border-box;
            outline: none;
            transition: box-shadow 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message-input-container textarea:focus {
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            border-color: #007bff;
        }

        .message-input-container button {
            flex-shrink: 0;
            padding: 10px 20px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px; /* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–¥–∏—É—Å—É –ø–æ–ª—è –≤–≤–æ–¥–∞ */
            cursor: pointer;
            font-size: 16px; /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—é –≤–≤–æ–¥–∞ */
            font-family: 'Roboto', sans-serif;
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.3);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .message-input-container button:hover {
            background-color: #0056b3;
            box-shadow: 0 6px 10px rgba(0, 123, 255, 0.5);
        }

        .message-input-container button:active {
            background-color: #004085;
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.7);
        }

        .message, .user-message, .bot-message {
            font-size: 14px; /* –£–º–µ–Ω—å—à–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —à—Ä–∏—Ñ—Ç–∞ */
            line-height: 1.4; /* –†–µ–≥—É–ª–∏—Ä—É–π—Ç–µ –º–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
        }

        .message .timestamp {
            font-size: 12px; /* –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ */
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–∑—É–Ω–∫–æ–≤ */
        ::-webkit-scrollbar {
            width: 8px; /* –®–∏—Ä–∏–Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–∑—É–Ω–∫–∞ */
            height: 8px; /* –í—ã—Å–æ—Ç–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–∑—É–Ω–∫–∞ */
        }

        /* –¶–≤–µ—Ç –∏ —Ä–∞–¥–∏—É—Å –æ–±–ª–∞—Å—Ç–∏ –ø–æ–ª–∑—É–Ω–∫–∞ */
        ::-webkit-scrollbar-thumb {
            background-color: #adb5bd; /* –ú—è–≥–∫–∏–π —Å–µ—Ä—ã–π —Ü–≤–µ—Ç –ø–æ–ª–∑—É–Ω–∫–∞ */
            border-radius: 10px; /* –†–∞–¥–∏—É—Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏—è */
        }

        /* –§–æ–Ω–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å –ø–æ–ª–∑—É–Ω–∫–∞ */
        ::-webkit-scrollbar-track {
            background-color: #e9ecef; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω –ø–æ–¥ –ø–æ–ª–∑—É–Ω–∫–æ–º */
            border-radius: 10px; /* –†–∞–¥–∏—É—Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏—è —Ñ–æ–Ω–∞ */
        }

        /* –ü–æ–ª–∑—É–Ω–æ–∫ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ */
        ::-webkit-scrollbar-thumb:hover {
            background-color: #6c757d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ü–≤–µ—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="users active" id="user-list">
                {% for user in users %}
                    {% if loop.first or users[loop.index0 - 1].time_category != user.time_category %}
                        <h3>{{ user.time_category }}</h3>
                    {% endif %}
                    <div class="user-list-item {% if user.has_request %}has-request{% endif %}"
                         data-session-id="{{ user.session_id }}"
                         onclick="selectUser(this); loadUserMessages('{{ user.session_id }}')">
                        <strong>{{ user.display_name }}</strong>
                        <button class="toggle-details" onclick="toggleDetails(this)">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                        <div class="user-agent">{{ user.user_agent }}</div>
                        <div class="page-url">{{ user.page_url }}</div>
                        <div class="last-message-time">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {{ user.last_message_time }}</div>
                    </div>
                {% endfor %}
            </div>
            <div class="chat-window" id="chatWindow" style="display: none;">
                <button class="back-button" id="backButton">–ù–∞–∑–∞–¥</button>
                <div class="messages-list" id="messagesList">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                </div>
            </div>
        </div>

        <div class="content" id="messages-container">
            <h2 id="messages-header">–°–æ–æ–±—â–µ–Ω–∏—è</h2>
            <div class="messages" id="messages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
            </div>
            <div class="message-input-container" id="message-input-container">
                <textarea id="admin-message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                <button id="send-admin-message">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <div class="requests-column" id="requests-container">
            <h2>–ó–∞—è–≤–∫–∏</h2>
            <div id="requests">
                {% for req in requests %}
                <div class="request {% if req.time_category == '–°–µ–≥–æ–¥–Ω—è' %}highlight{% endif %}">
                    <div class="contact-info">
                        <div class="name-container">
                            <strong></strong> {{ req.name }}
                        </div>
                        <div class="phone-container">
                            <strong></strong> {{ req.phone }}
                        </div>
                    </div>
                    <div class="message-content">
                        <strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> {{ req.message }}
                    </div>
                    <div class="timestamp">
                        <strong>{{ req.time_category }}:</strong> {{ req.timestamp }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

    <script>
        const socket = io('https://bot-fit.ru', { transports: ['websocket', 'polling'] });

        socket.on('connect', () => {
            console.log('Connected to WebSocket');
        });

        socket.on('new_message', msg => {
            console.log("New message received:", msg);

            // –ü–æ–ª—É—á–∞–µ–º sessionId —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const selectedUser = document.querySelector('.user-list-item.selected');
            const selectedSessionId = selectedUser ? selectedUser.getAttribute('data-session-id') : null;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            if (selectedSessionId && selectedSessionId === msg.user_session) {
                displayMessage(msg); // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–≥–æ
            } else {
                console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ.');
            }
        });


        function displayMessage(msg) {
            console.log("Displaying message:", msg);
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(msg.sender === 'user' ? 'user-message' : msg.sender === 'bot' ? 'bot-message' : 'admin-message');

            const formattedText = formatText(msg.text).replace(/\n/g, '<br>');

            const timestamp = new Date(msg.timestamp);
            timestamp.setHours(timestamp.getHours() + 3);

            const formattedTime = timestamp.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `<strong class="${msg.sender}">${msg.sender}:</strong> ${formattedText} <div class="timestamp">${formattedTime}</div>`;
            messagesContainer.appendChild(messageDiv);

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥–æ—á–µ–∫ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        function formatText(text) {
            return text.replace(/\*\*/g, ''); // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è **
        }


        document.addEventListener('DOMContentLoaded', function() {
            const firstUser = document.querySelector('.user-list-item');

            if (firstUser) {
                selectUser(firstUser);

                // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const sessionId = firstUser.getAttribute('data-session-id');
                loadUserMessages(sessionId);

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                setInterval(() => {
                    const selectedUser = document.querySelector('.user-list-item.selected');
                    if (selectedUser) {
                        const sessionId = selectedUser.getAttribute('data-session-id');
                        loadUserMessages(sessionId);
                    }
                }, 5000); // –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            }
        });



        document.getElementById('send-admin-message').addEventListener('click', sendMessage);

        function sendMessage() {
            const message = document.getElementById('admin-message-input').value;
            const selectedUser = document.querySelector('.user-list-item.selected');
            if (!selectedUser || !message) return;

            const userSession = selectedUser.getAttribute('data-session-id');

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Å—Ä–∞–∑—É
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'admin-message');
            const timestamp = new Date();
            const formattedTime = timestamp.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            messageDiv.innerHTML = `<strong class="admin">admin:</strong> ${message} <div class="timestamp">${formattedTime}</div>`;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            fetch('/send_admin_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `userSession=${encodeURIComponent(userSession)}&message=${encodeURIComponent(message)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('admin-message-input').value = '';
                    // –û–±–Ω–æ–≤–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                    loadUserMessages(userSession);
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        function selectUser(element) {
            const users = document.querySelectorAll('.user-list-item');
            users.forEach(user => user.classList.remove('selected'));
            element.classList.add('selected');

            const contentPanel = document.getElementById('messages-container');
            const sidebar = document.getElementById('sidebar');
            const requestsColumn = document.getElementById('requests-container');

            contentPanel.classList.add('active');
            sidebar.classList.remove('active');
            sidebar.classList.add('hidden');
            requestsColumn.classList.remove('active');
            requestsColumn.classList.add('hidden');

            const messageInputContainer = document.getElementById('message-input-container');
            messageInputContainer.style.display = 'flex';

            const userName = element.querySelector('strong').textContent;
            const header = document.getElementById('messages-header');
            header.textContent = userName;
        }

        let autoScroll = true;

        document.getElementById('messages').addEventListener('scroll', function() {
            const messagesContainer = this;
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –≤–≤–µ—Ä—Ö, –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            if (messagesContainer.scrollTop + messagesContainer.clientHeight < messagesContainer.scrollHeight) {
                autoScroll = false;
            } else {
                autoScroll = true;
            }
        });


        function loadUserMessages(sessionId) {
            const timestamp = new Date().getTime();
            fetch(`/proxy/history?userSession=${sessionId}&_=${timestamp}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    }
                    return response.json();
                })
                .then(data => {
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—É—â–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–π

                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('message');
                            messageDiv.classList.add(msg.sender === 'user' ? 'user-message' : msg.sender === 'bot' ? 'bot-message' : 'admin-message');

                            const formattedText = formatText(msg.text).replace(/\n/g, '<br>');

                            const timestamp = new Date(msg.timestamp);
                            timestamp.setHours(timestamp.getHours() + 3);

                            const formattedTime = timestamp.toLocaleString('ru-RU', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            messageDiv.innerHTML = `<strong class="${msg.sender}">${msg.sender}:</strong> ${formattedText} <div class="timestamp">${formattedTime}</div>`;
                            messagesContainer.appendChild(messageDiv);
                        });

                        // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (autoScroll) {
                            setTimeout(() => {
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω—ã
                        }
                    } else {
                        console.warn('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                });
        }


        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥–æ—á–µ–∫ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        function formatText(text) {
            return text.replace(/\*\*/g, ''); // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è **
        }


        function toggleDetails(button) {
            const userDiv = button.parentElement;
            const userAgent = userDiv.querySelector('.user-agent');
            const pageUrl = userDiv.querySelector('.page-url');
            const isVisible = userAgent.style.display === 'block';

            if (isVisible) {
                userAgent.style.display = 'none';
                pageUrl.style.display = 'none';
                button.textContent = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
            } else {
                userAgent.style.display = 'block';
                pageUrl.style.display = 'block';
                button.textContent = '–°–∫—Ä—ã—Ç—å';
            }
        }
    </script>
</body>
</html>
